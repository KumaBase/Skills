---
name: my-schedule
description: Fetch and summarize today's, tomorrow's or next week's schedule from multiple Google Calendars via Chatwork or GAS API. Use when the user says "今日の予定", "明日の予定", "来週の予定", "予定教えて", "スケジュール", or asks about their schedule.
---

# スケジュール確認スキル

複数カレンダーの予定をまとめて表示する。取得方法は日付により異なる。

## 対応パターン

| ユーザーの入力 | 動作 |
|----------------|------|
| 「今日の予定」「予定教えて」 | **今日 + 明日 + 来週** の3つをまとめて表示 |
| 「明日の予定」 | 明日の予定のみ表示 |
| 「来週の予定」 | 来週の予定のみ表示 |

**デフォルト動作**: 「今日の予定」と言われたら、今日・明日・来週の3セットを一度に表示する。

## カレンダー一覧

| カレンダー名 | 投稿者 account_id | 内容 |
|-------------|-------------------|------|
| KumaBase | 8862983 | Kuma Base 業務・プライベート |
| iYell | 8749976 | iYell 業務 |
| coreal | 8749976 | Coreal 業務 |

## ワークフロー

### 取得方法A: Chatwork経由（今日・来週）

#### Step A1: Chatworkからメッセージ取得

```bash
curl -s "https://api.chatwork.com/v2/rooms/395191594/messages?force=1" \
  -H "X-ChatWorkToken: ${CHATWORK_API_TOKEN}"
```

**注意**: `CHATWORK_API_TOKEN` は `.env` から取得する。`.env` が存在しない場合はユーザーに聞く。

#### Step A2: メッセージをフィルタリング

レスポンスはJSON配列。各メッセージの `body` からタイトルパターンで絞り込む。

**今日の予定の場合**:
- タイトルパターン: `{カレンダー名}の今日の予定 (YYYY/MM/DD)`
- 今日の日付に一致するメッセージを各カレンダーから**最新1件ずつ**取得

**来週の予定の場合**:
- タイトルパターン: `{カレンダー名}の来週の予定 (YYYY/MM/DD〜YYYY/MM/DD)`
- 最新の「来週の予定」メッセージを各カレンダーから**最新1件ずつ**取得

### 取得方法B: GAS API経由（明日・任意の日付）

Chatworkに投稿されていない日付の予定は、各アカウントのGAS APIから直接取得する。

#### Step B1: 3つのGAS APIを呼び出す

```bash
# KumaBase
curl -sL "${GAS_CALENDAR_KB_URL}?action=events&date=YYYY-MM-DD"
# iYell
curl -sL "${GAS_CALENDAR_IYELL_URL}?action=events&date=YYYY-MM-DD"
# coreal
curl -sL "${GAS_CALENDAR_COREAL_URL}?action=events&date=YYYY-MM-DD"
```

**レスポンス形式**:
```json
{
  "calendarName": "KumaBase",
  "date": "2026-02-04",
  "events": [
    { "startTime": "09:00", "title": "打ち合わせ" },
    { "startTime": "13:00", "title": "ミーティング" }
  ]
}
```

**注意**: レスポンスの `calendarName` が空の場合がある。その場合は呼び出したURLの環境変数名からカレンダー名を判定する:
- `GAS_CALENDAR_KB_URL` → KumaBase
- `GAS_CALENDAR_IYELL_URL` → iYell
- `GAS_CALENDAR_COREAL_URL` → coreal

#### Step B2: 3つのレスポンスをマージ

取得方法Aと同じパース＆マージ処理（Step 3以降）に進む。

### Step 3: パース＆マージ

全カレンダーの予定を1つのリストに統合する。

**各予定の抽出ルール**:
- Chatworkメッセージ本文の各行から `HH:MM イベント名` のパターンを抽出
- 各予定にカレンダーラベルを付与: `[KB]` / `[iYell]` / `[coreal]`
- `config.md` の「除外キーワード」に該当する予定は除外する
- 全予定を **時刻の昇順** でソートする

**ラベル対応**:
| カレンダー名 | ラベル |
|-------------|--------|
| KumaBase | `[KB]` |
| iYell | `[iYell]` |
| coreal | `[coreal]` |

### Step 4: 過ぎた予定のグレーアウト（今日のみ）

**今日の予定**を表示する際、現在時刻より前の予定は取り消し線で表示する。

- 現在時刻と各予定の開始時刻を比較する
- 過ぎた予定: `| ~~09:00~~ | ~~[iYell] 【社内：meet】🌷全社朝礼🌷~~ |`
- まだの予定: 通常表示
- 明日・来週の予定には適用しない

### Step 5: 空き時間の検出

**今日と明日の予定**で、予定と予定の間が **1時間以上** 空いている場合にギャップ行を挿入する。来週の予定では空き時間を表示しない。

- `00:00` 開始の予定（終日予定）はギャップ計算から除外する
- ギャップは直前の予定の時刻と次の予定の時刻の差で判定する（予定の所要時間は不明なので、開始時刻同士の差を使う）
- 今日の予定でグレーアウトされた時間帯のギャップは表示しない（過ぎた空き時間は不要）

### Step 5.5: 予定の重複検出

全カレンダーをマージした後、**同じ時刻**に2つ以上の予定がある場合、重複警告を表示する。

- 同じ `HH:MM` に異なるカレンダーの予定がある場合に検出する
- 予定テーブルの**上**に警告を表示:

```
> ⚠ **予定の重複**
> - 13:00 に [iYell] 定例：初瀬×吉田 と [KB] Dセミナー が重複しています
```

- 重複がなければこのセクションは表示しない
- 今日・明日・来週すべてで検出する

### Step 6: 整形して表示

#### 今日の予定の表示形式

テーブル形式で表示する。見出しの日付には正しい曜日（日〜土）を付ける:

例: 現在14:30の場合

```
## 📅 今日の予定（2026/02/03 火）

| 時間 | 予定 |
|------|------|
| ~~08:00~~ | ~~[KB] 酒井さんの銀行残高チェック~~ |
| ~~09:00~~ | ~~[iYell] 【社内：meet】🌷全社朝礼🌷~~ |
| ~~09:30~~ | ~~[iYell] 【社内@meet】システム企画部朝礼~~ |
| ~~13:00~~ | ~~[iYell] 定例：初瀬×吉田~~ |
| _15:00-15:30_ | _--- 空き ---_ |
| 15:30 | [iYell] 【meet】全社会議 |
| 16:30 | [iYell] 悠真プール |
| 17:00 | [iYell] ジム |
| 19:00 | [iYell] 全社懇親会 |
```

#### 来週の予定の表示形式

日付ごとにテーブルを分ける:

```
## 📅 来週の予定（02/09〜02/13）

### 02/09(月)
| 時間 | 予定 |
|------|------|
| 16:30 | [coreal] 【対面＆MEET】Coreal定例 |

### 02/12(木)
| 時間 | 予定 |
|------|------|
| 08:00 | [coreal] Coreal MTG |
| 12:00 | [KB] 前入り |
| 13:00 | [KB] Dセミナー |
| 17:30 | [KB] プログラミング(悠真) |

### 02/13(金)
| 時間 | 予定 |
|------|------|
| 17:15 | [KB] ジム |
| 17:30 | [KB] 🐈‍⬛話す力(悠真) |
```

### 予定がない場合

- 該当日のメッセージが見つからない場合: 「予定はまだChatworkに投稿されていません」と表示
- Chatwork APIエラーの場合: エラー内容をユーザーに伝える

## 表示ルール

- Chatwork記法（`[info]`, `[title]`, `[hr]` 等）は除去してプレーンテキストとして扱う
- 空き時間行はイタリック（`_..._`）で視覚的に区別する
- 予定が0件の日（来週表示）は日付ヘッダーごと省略する

## Step 7: 想定タスクの表示

予定テーブルの**下**に、準備が必要な予定の想定タスクを表示する。
固定タスク・汎用タスクキーワード・除外キーワードの定義は [config.md](config.md) を参照すること。

### マッチ順序

1. `config.md` の「固定タスク」テーブルを上から順にチェック（固定タスクが優先）
2. 固定タスクに一致しなかった予定のうち、`config.md` の「汎用タスクキーワード」を含む場合は汎用メッセージを表示

### 表示形式

予定テーブルの下に、該当する予定分だけ表示する:

```
> **想定タスク**
> - 14:00 NS bridge お打ち合わせ → 議事録の準備しよう [議事録](https://docs.google.com/document/d/1HzHwUT0fCCvNGNgu3rGNMd97VRCCXfeTH1qVLcVwPPg/edit?tab=t.0#heading=h.22ljfjqh4nzt)
> - 16:30 Coreal定例 → 進めておこう！
> - 13:00 Dセミナー → 議事録や事前準備が必要かも
```

- 該当する予定が1件もなければ「想定タスク」セクション自体を表示しない
- 今日・明日・来週それぞれのテーブルの下に個別に表示する

## 環境変数

| 変数 | 用途 |
|------|------|
| `CHATWORK_API_TOKEN` | Chatwork API トークン |
| `GAS_CALENDAR_KB_URL` | KumaBaseカレンダーGASのデプロイURL |
| `GAS_CALENDAR_IYELL_URL` | iYellカレンダーGASのデプロイURL |
| `GAS_CALENDAR_COREAL_URL` | corealカレンダーGASのデプロイURL |

## 前提条件

- GASが毎日/毎週、Googleカレンダーの予定をChatwork room `395191594` に投稿済み
- 各アカウントのGASに `doGet(action=events)` がデプロイ済み（手順は `Task/gas-calendar-api.js` を参照）
- `.env` に上記の環境変数が設定済み
