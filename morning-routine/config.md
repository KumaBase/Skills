# morning-routine 設定

## 曜日判定

### タイムゾーン

すべての日時処理は **Asia/Tokyo（JST）** 基準。

### 判定ロジック

```bash
WEEKDAY=$(TZ=Asia/Tokyo date +%u)
# 1=月, 2=火, ..., 6=土, 7=日

IS_SATURDAY=$([[ "$WEEKDAY" == "6" ]] && echo true || echo false)
IS_SUNDAY_OR_MONDAY=$([[ "$WEEKDAY" == "7" || "$WEEKDAY" == "1" ]] && echo true || echo false)
```

### 曜日別実行セクション

| 曜日 | 実行セクション |
|------|---------------|
| 火〜金 | 今日の予定, chatwork-summary, タスクリマインド |
| 土 | 上記 + 来週の予定 |
| 日・月 | 今日の予定, chatwork-summary, タスクリマインド + task-due-fix, weekly-report |

## スキルフィルタルール

### フィルタ優先順位

1. **ポジティブフィルタ優先**: 「〜だけ」「〜のみ」が含まれる場合 → 指定セクションのみ実行（ネガティブフィルタは無視）
2. **ネガティブフィルタ**: 「〜なし」「〜抜き」のみの場合 → 指定セクションをスキップ
3. **フィルタなし**: どちらもなし → フル実行

### 付加オプション（「〜も」）

フィルタとは別枠で処理。フィルタ適用後の実行セットに**追加**する形で動作し、他セクションの実行には影響しない。

| キーワード | 動作 |
|-----------|------|
| 「返信案も」「返信も」 | フル実行 + chat-reply を統合出力に含める（Step 5 の質問をスキップ） |

- ポジティブ/ネガティブフィルタと併用可能: 「おはよう 予定だけ 返信案も」→ 今日の予定 + chat-reply
- 「〜なし」で打ち消し: 「返信なし」→ ネガティブフィルタとして Step 5 自体をスキップ

### 複合指定ルール

入力に含まれるキーワードをすべて収集し、**和集合（OR）** で適用。

**否定スコープ**: 「〜なし」「〜抜き」は直前のキーワードにのみ適用。

- 「予定とチャットだけ」→ 今日の予定 + chatwork-summary のみ実行
- 「チャットなし」→ chatwork-summary のみスキップ
- 「タスクなし チャットなし」→ タスクリマインド と chatwork-summary をスキップ

**キーワードマッチング**: 最長一致優先。キーワードマッピングの照合時、長いキーワードを先に照合する。

マッチ優先順序:
1. 「来週の予定」「来週」→ 来週の予定 ※「予定」は消費済みのため今日版は含まない
2. 「チャットまとめ」→ chatwork-summary ※「チャット」は消費済み
3. 「期限修正」→ task-due-fix ※「期限」は消費済み
4. 上記で消費されなかったキーワードを単体マッチ

**派生スキルの扱い**: 「予定」単独→ 今日の予定のみ。「来週の予定」「来週」→ 来週の予定のみ。

### キーワードマッピング

| キーワード | 対象セクション |
|-----------|---------------|
| 「予定」「スケジュール」 | 今日の予定 |
| 「チャット」「チャットまとめ」 | chatwork-summary |
| 「タスク」「リマインド」 | タスクリマインド |
| 「期限」「期限修正」 | task-due-fix |
| 「週報」「レポート」 | weekly-report |
| 「来週」「来週の予定」 | 来週の予定 |
| 「返信」「返信案」「リプライ」 | chat-reply |

### フィルタ適用例

| 入力 | 判定 | 実行セクション |
|------|------|---------------|
| 「おはよう」 | フィルタなし | 全セクション（曜日に応じて） |
| 「おはよう 予定だけ」 | ポジティブ: [今日の予定] | 今日の予定のみ |
| 「おはよう 予定とチャットだけ」 | ポジティブ: [今日の予定, chatwork-summary] | 今日の予定 + chatwork-summary |
| 「おはよう 来週の予定だけ」 | ポジティブ: [来週の予定] | 来週の予定のみ |
| 「おはよう チャットなし」 | ネガティブ: [chatwork-summary] | 今日の予定 + タスクリマインド（+ 曜日別） |
| 「おはよう タスクなし チャットなし」 | ネガティブ: [タスクリマインド, chatwork-summary] | 今日の予定（+ 曜日別） |
| 「おはよう 予定だけ チャットなし」 | ポジティブ優先: [今日の予定] | 今日の予定のみ（ネガティブ無視） |
| 「おはよう 返信案も」 | 付加オプション: [chat-reply] | 全セクション + chat-reply（質問スキップ、統合出力に含める） |
| 「おはよう 返信なし」 | ネガティブ: [chat-reply] | 全セクション、Step 5 もスキップ |

### フィルタ適用内容の表示

統合出力の先頭（日付の下）にフィルタ適用内容を引用ブロック1行で表示する。
フィルタなし かつ 付加オプションなし（完全なフル実行）の場合は表示しない。

**表示パターン**:

| フィルタ種別 | 表示形式 | 例 |
|------------|---------|-----|
| ポジティブ | `> 実行: {セクション名}` | `> 実行: 予定, チャットまとめ` |
| ネガティブ | `> スキップ: {セクション名}` | `> スキップ: チャットまとめ` |
| ポジティブ + 付加 | `> 実行: {セクション名} / 追加: {セクション名}` | `> 実行: 予定 / 追加: 返信案` |
| ネガティブ + 付加 | `> スキップ: {セクション名} / 追加: {セクション名}` | `> スキップ: チャットまとめ / 追加: 返信案` |
| フィルタなし | 表示しない | — |
| 付加オプションのみ | `> 追加: {セクション名}` | `> 追加: 返信案` |

**複合・エッジケース**:

| ケース | 表示 | 理由 |
|--------|------|------|
| ポジティブ + ネガティブ併用 | ポジティブのみ表示 | 既存ルール「ポジティブ優先、ネガティブ無視」に準拠 |
| フィルタ指定したが曜日制約で実行対象0件 | フィルタ行を表示 + 本文で「該当セクションなし」 | ユーザーの指定意図を明示 |
| 付加オプションのみ（「おはよう 返信案も」） | `> 追加: 返信案` | 基本セクションはフル実行のためフィルタ表示なし、追加分のみ表示 |

**セクション名表記**:

| 内部名 | 表示名 |
|--------|--------|
| 今日の予定 | 予定 |
| 来週の予定 | 来週の予定 |
| chatwork-summary | チャットまとめ |
| タスクリマインド | タスクリマインド |
| task-due-fix | 期限修正 |
| weekly-report | 週報 |
| chat-reply | 返信案 |

## バッチ実行ルール

API呼び出しは可能な限り **1回の bash 実行で複数の curl を並列処理** し、承認回数を最小化する。

### バッチ1: カレンダー（今日の予定）

- 対象: fetch-calendar（3カレンダー × 今日の日付のみ）
- 並列数: 3
- 承認: 1回

### バッチ2: タスク（リマインド + 個人タスク通知）

- 対象: fetch-tasks（overdue + due_soon + personal + 全プロジェクトタスク）
- 並列数: 4
- 承認: 1回
- 用途: タスクリマインド整形 + 個人タスク通知算出

### バッチ3: 来週カレンダー（土曜のみ）

- 対象: fetch-calendar（3カレンダー × 来週月〜金の5日分）
- 並列数: 15
- 承認: 1回

### 承認回数の目安

| 曜日 | バッチ1 | バッチ2 | chatwork | バッチ3 | その他 | 合計 |
|------|---------|---------|----------|---------|--------|------|
| 火〜金 | 1 | 1 | 2~5 | - | - | 4~7 |
| 土 | 1 | 1 | 2~5 | 1 | - | 5~8 |
| 日・月 | 1 | 1 | 2~5 | - | task-due-fix + weekly-report | 7~12 |

## セクション別設定

### chatwork-summary

- 対象: 「昨日のチャットまとめ」
- 期間: 昨日（JST基準）

### task-due-fix（日曜・月曜のみ）

- 対象: 期限未設定 + 期限切れタスク
- 用途: 週の始まりに整理

### weekly-report（日曜・月曜のみ）

- 対象: 週報生成
- 内容: 前週の完了タスク + 来週の予定

### chat-reply（Step 5 で質問 or フィルタで明示指定）

- 対象: 「返信案」として実行（昨日の自分宛メッセージ）
- ソース: Chatwork + LINE（chat-reply のデフォルト動作）

## 個人タスク通知

### 概要

統合出力末尾に、自分のタスクの期限状態を簡易通知する。バッチ2 で取得済みデータから算出するため、追加API呼び出しは不要。

### 対象

- `_shared/config.md` の「Kuma Taskboard メンバーマッピング」の自分（assignee_user_id）
- `_shared/config.md` の「Taskboard プロジェクト設定」のプロジェクトキー
- `_shared/config.md` の「Taskboard プロジェクト設定」の完了ステータスID

### 算出方法

| 種別 | データソース | 算出方法 |
|------|------------|---------|
| 期限切れ件数 | バッチ2 の overdue + personal | overdue の完了除外後件数 + personal の `due_date < today` 件数 |
| 期限未設定件数 | バッチ2 の mr_all_project + personal | mr_all_project の `due_date == null` かつ完了除外 + personal の `due_date == null` 件数 |

### フィルタとの関係

- **フィルタ対象外**: ポジティブ/ネガティブフィルタに関わらず常に実行
- ルーティンが実行される限り表示（0件の場合は非表示）

## カレンダー整形設定

schedule-formatter および task-suggester で使用する設定。このファイルが正本。変更時は morning-routine/config.md のみを編集する。

### 除外キーワード

以下のキーワードに完全一致または含まれる予定は表示しない。

- `ランチ`
- `自宅`
- `退勤`

### 固定タスク

予定名に一致する場合、固定のメッセージを表示する。
マッチ方法が「部分一致」のものは予定名の一部に含まれていればマッチする。それ以外は完全一致。

| 予定名 | マッチ | メッセージ |
|--------|--------|-----------|
| NS bridge お打ち合わせ | 完全一致 | 議事録の準備しよう [議事録](https://docs.google.com/document/d/1HzHwUT0fCCvNGNgu3rGNMd97VRCCXfeTH1qVLcVwPPg/edit?tab=t.0#heading=h.22ljfjqh4nzt) |
| KAFAさんお打ち合わせ | 完全一致 | 議事録の準備とタスク一覧を作ろう |
| NS定例ミーティング | 完全一致 | 議事録の準備しよう [議事録](https://docs.google.com/document/d/1CL01TlGEq7Z3mZwUph_NG8ZFXI46nfHx7PIj700LiZY/edit?tab=t.0#heading=h.82ve2gz1rag3) |
| Coreal定例 | 部分一致 | 進めておこう！ |
| リベ勉強会 | 完全一致 | 資料準備：） |
| スキルマーケット | 部分一致 | 準備をしよう |

### 汎用タスクキーワード

固定タスクに一致しなかった予定のうち、以下のキーワードを含む場合は汎用メッセージを表示する。

- `打ち合わせ`、`お打ち合わせ`、`MTG`、`ミーティング`、`定例`、`会議`、`セミナー`、`勉強会`

汎用メッセージ: `議事録や事前準備が必要かも`

## 再表示機能

### 保持方式

- **保持先**: 同一会話セッションのコンテキスト（AIの会話メモリ）
- **保存対象**: 最後の morning-routine 実行結果（Markdown全文）
- **有効期間**: 同一セッション内かつ JST 基準で同日

### フォールバック応答

| 状況 | 応答 |
|------|------|
| 同一セッション内で実行済み | 前回の出力を再表示 |
| 同一セッションだが日付が変わった | 「日付が変わりました。「おはよう」で新しいルーティンを実行できます。」 |
| 実行履歴なし | 「まだ今日のモーニングルーティンを実行していません。「おはよう」で実行できます。」 |
| 新規セッション | 「前回のセッション結果は保持されていません。「おはよう」で新しいルーティンを実行できます。」 |

## 長文対策

各セクション出力が50行を超える場合:

1. セクション先頭に `### 要約` ブロックを追加
2. 要約の後に `<!-- details -->` コメントを挿入（`---` はセクション区切り専用のため使用しない）
3. 全文はそのまま残す

## エラーハンドリング

セクション実行失敗時は、**該当セクション内**にエラーを表示し、他のセクションは継続して実行。
